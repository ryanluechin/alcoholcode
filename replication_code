#packages

packlist <- c("haven", "modelsummary")
install.packages(packlist[!(packlist %in% installed.packages()[, 1])])

#renv::install("MASS@7.3-60")
packlist <- c("wooldridge", "lmtest", "sandwich", "modelsummary")
install.packages(packlist[!(packlist %in% installed.packages()[, 1])])

library(wooldridge)
library(lmtest)
library(sandwich)
library(modelsummary)
#first inall packages

#renv::install("MASS@7.3-60")

packlist <- c("wooldridge", "modelsummary", "ivreg",  "lmtest", "sandwich")
install.packages(packlist[!(packlist %in% installed.packages()[, 1])])

library(ivreg)
library(modelsummary)
library(lmtest)
library(sandwich)
library(tidyr)
library(dplyr)
library(modelsummary)
library(psych)
library(broom)
library(ivreg)
library(modelsummary)
library(lmtest)
library(sandwich)

# Drop specific states
df <-alcohol_data %>% filter(!(state %in% c(15, 54)))

#arange data for time series analysis
df <- df %>% arrange(state, year)

#create new variables

df <- df %>%
  mutate(
    excise_price = 1 + beer_tax / 100,
    salestax_price = 1 + salestax / 100,
    beer_per_cap = c_beer / population,
    
    ln_excise_price = log(excise_price),
    ln_salestax_price = log(salestax_price),
    ln_cons_beer = log(beer_per_cap),
    ln_population = log(population),
    ln_income = log(st_income / population),
    ln_unemp_rate = log(st_uemp_rate)
  ) %>%
  arrange(state, year) %>%
  group_by(state) %>%
  mutate(
    dln_population = ln_population - lag(ln_population),
    dln_income = ln_income - lag(ln_income),
    dln_unemp_rate = ln_unemp_rate - lag(ln_unemp_rate),
    dln_excise_price = ln_excise_price - lag(ln_excise_price),
    dln_salestax_price = ln_salestax_price - lag(ln_salestax_price),
    dln_cons_beer = ln_cons_beer - lag(ln_cons_beer)
  ) %>%
  ungroup()


#table 5 summary statistics chart generation

df <- df %>%
  mutate(beer_per_cap = beer_per_cap * 24 / 2.25) %>%
  mutate(
    policy_change = d_driving_age != 0 | d_bac_teen_02 != 0 | d_lower_limit != 0 | d_bac_10 != 0 | d_bac_08 != 0 | d_admin_license_rev != 0,
    policy_change = ifelse(is.na(d_driving_age), NA, policy_change),
    d21 = da >= 21
  )

summary_stats <- df %>%
  select(beer_per_cap, btax_dollars, beer_tax, salestax, d21, policy_change) %>%
  describe()

print(summary_stats)


# TABLE 6: COLUMN 1 BASELINE
baseline_model <- lm(dln_cons_beer ~ dln_excise_price + dln_salestax_price + dln_population + factor(year), data = df)
test <- coeftest(baseline_model, vcov = vcovHC(baseline_model))  # White's heteroskedasticity-robust standard errors
print(summary(baseline_model))
print(test)

# TABLE 6: COLUMN 2 ADD ECONOMIC CONTROLS
economic_model <- lm(dln_cons_beer ~ dln_excise_price + dln_salestax_price + dln_population + dln_income + dln_unemp_rate + factor(year), data = df)
test <- coeftest(economic_model, vcov = vcovHC(economic_model))
print(summary(economic_model))
print(test)

# TABLE 6: COLUMN 3 ADD ALCOHOL POLICY CONTROLS
alcohol_policy_model <- lm(dln_cons_beer ~ dln_excise_price + dln_salestax_price + dln_population + dln_income + dln_unemp_rate + factor(year) + d_bac_teen_02, data = df)
test <- coeftest(alcohol_policy_model, vcov = vcovHC(alcohol_policy_model))
print(summary(alcohol_policy_model))
print(test)

# TABLE 6: COLUMN 4 ADD REGION TRENDS
data$year <- as.factor(data$year)  # Ensure 'year' is treated as a factor
region_trends_model <- lm(dln_cons_beer ~ dln_excise_price + dln_salestax_price + dln_population + dln_income + dln_unemp_rate + factor(year) + factor(region), data = df)
test <- coeftest(region_trends_model, vcov = vcovHC(region_trends_model))
print(summary(region_trends_model))
print(test)

#scatter plots

# Load necessary package
library(ggplot2)

# Assuming your data is stored in a dataframe called `data`

# Filter data for plotting
data_filtered_e <- subset(df, abs(dln_excise_price) < 0.02)
data_filtered_s <- subset(df, abs(dln_salestax_price) < 0.02)


# Calculate the mean of the variable
mean_value <- mean(data_filtered_e$dln_cons_beer, na.rm = TRUE)

# Add a new column with the mean value
data_filtered_e <- data_filtered_e %>%
  mutate(mean_dln_cons_beer = mean_value)


# Figure 2a
fig2a <- ggplot(data_filtered_e, aes(x = dln_excise_price, y = dln_cons_beer)) +
  geom_point(size = 1) +  # equivalent to msize(small)
  geom_smooth(method = "lm", se = FALSE, color = "blue") +  # linear fit
  labs(
    title = "Figure 2a",
    subtitle = "Per Capita Beer Consumption and State Beer Excise Taxes",
    x = "Change in Log(1+Beer Excise Rate)",
    y = "Change in Log Per Capita Beer Consumption"
  ) +
  scale_x_continuous(limits = c(-0.02, 0.02), breaks = seq(-0.02, 0.02, 0.005)) +
  theme_minimal() +
  theme(legend.position = "none")

# Print Figure 2a
print(fig2a)


# Figure 2b
fig2b <- ggplot(data_filtered_s, aes(x = dln_salestax_price, y = dln_cons_beer)) +
  geom_point(size = 1) +  # equivalent to msize(small)
  geom_smooth(method = "lm", se = FALSE, color = "blue") +  # linear fit
  labs(
    title = "Figure 2b",
    subtitle = "Per Capita Beer Consumption and State Sales Taxes",
    x = "Change in Log(1+Sales Tax Rate)",
    y = "Change in Log Per Capita Beer Consumption"
  ) +
  scale_x_continuous(limits = c(-0.02, 0.02), breaks = seq(-0.02, 0.02, 0.005)) +
  theme_minimal() +
  theme(legend.position = "none")

# Print Figure 2b
print(fig2b)



